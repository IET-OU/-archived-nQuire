<?php

function pi_inquiry_manager_block($op = 'list') {
	switch ($op) {
		case 'list':
			$blocks = array();
			$blocks[0]['info'] = t('Inquiry management');
			return $blocks;

		case 'view':
			global $user;

			$node_details = get_inquiry_details_from_current_path();
			$inquiry_id = isset($node_details->inquiry_id) ? $node_details->inquiry_id : FALSE;
			$inquiry = node_load($inquiry_id);

			if ($inquiry && $inquiry->type === 'pi_inquiry') {
				$tools = array();

				$tools[] = t('Stages');
				$tools[] = l(t('Participants'), "inquiry/$inquiry_id/participants");
				$tools[] = t('Activity status');

				if ($user->uid === $inquiry->uid) {
					$path = inquiry_design_path_to_inquiry_design($inquiry_id);
					if ($path) {
						$tools[] = l(t('Edit inquiry'), $path);
					}
				}

				$content = t(theme('item_list', $tools, NULL, 'ul', array('class' => 'menu')));

				return array(
						'subject' => t('Inquiry management'),
						'content' => $content
				);
			}
			return NULL;
	}
}

function pi_inquiry_manager_menu() {
	$items = array(
			'inquiry/%/participants' => array(
					'title' => 'Inquiry participant',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/access' => array(
					'title' => 'Participant access configuration',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_edit_inquiry_group',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_configure_inquiry_participants_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/join' => array(
					'title' => 'Join inquiry',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_join',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_join_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/leave' => array(
					'title' => 'Leave inquiry',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_leave',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_leave_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/invite' => array(
					'title' => 'Invite users',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_invite_users',
					'page arguments' => array(1, 4),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/acceptinvitation' => array(
					'title' => 'Accept invitation',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_acceptinvitation',
					'page arguments' => array(1, 4),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_acceptinvitation_access',
					'access arguments' => array(1),
					'weight' => 1,
			), 'inquiry/%/participants/accept/%' => array(
					'title' => 'Accept user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_accept_user',
					'page arguments' => array(1, 4, 5),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/reject/%' => array(
					'title' => 'Reject user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_reject_user',
					'page arguments' => array(1, 4, 5),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/adduserstorole/%' => array(
					'title' => 'Reject user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_adduserstorole',
					'page arguments' => array(1, 4), // (inquiry_id, role_id)
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/addrolestouser/%' => array(
					'title' => 'Reject user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_addrolestouser',
					'page arguments' => array(1, 4), // (inquiry_id, uid)
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/removeuserrole/%/%' => array(
					'title' => 'Reject user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_group_removeuserrole',
					'page arguments' => array(1, 4, 5), // (inquiry_id, uid, rold_id)
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_group_manageuser_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/groupmanagement' => array(
					'title' => 'Reject user',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_subgroups_edit_policy',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_subgroups_edit_policy_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/createsubgroup' => array(
					'title' => 'Create subgroup',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_subgroups_create',
					'page arguments' => array(1),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_subgroups_create_access',
					'access arguments' => array(1),
					'weight' => 1,
			),
			'inquiry/%/participants/subgroup/%' => array(
					'title' => 'Inquiry subgroup',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_subgroup',
					'page arguments' => array(1, 4),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_subgroups_view_access',
					'access arguments' => array(1, 4),
					'weight' => 1,
			),
			'inquiry/%/participants/subgroup/%/edit' => array(
					'title' => 'Create subgroup',
					'file' => 'pi_inquiry_manager.participants.inc',
					'page callback' => 'pi_inquiry_manager_participants_subgroup_edit',
					'page arguments' => array(1, 4),
					'type' => MENU_CALLBACK,
					'access callback' => 'pi_inquiry_manager_participants_subgroups_edit_access',
					'access arguments' => array(1, 4),
					'weight' => 1,
			),
	);

	return $items;
}

function pi_inquiry_manager_theme() {
	return array(
			'pi_inquiry_manager_participants_view_inquiry_group' => array(
					'arguments' => array('node'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
			'pi_inquiry_manager_participants_list' => array(
					'arguments' => array('group_nid', 'uid'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
			'pi_inquiry_manager_participants_group_status_and_options' => array(
					'arguments' => array('group_nid', 'uid'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
			'pi_inquiry_manager_participants_roles' => array(
					'arguments' => array('inquiry_node', 'group_nid'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
			'pi_inquiry_manager_participants_groups' => array(
					'arguments' => array('inquiry_node'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
			'pi_inquiry_manager_participants_group_access_policy' => array(
					'arguments' => array('inquiry_node', 'group_nid'),
					'file' => 'pi_inquiry_manager.participants.inc',
			),
	);
}

function pi_inquiry_manager_participants_access($nid) {
	/* TODO */

	return TRUE;
}

function pi_inquiry_manager_participants_group_configure_inquiry_participants_access($inquiry_nid) {
	global $user;
	$node = node_load($inquiry_nid);
	return $node->uid === $user->uid;
}

/* group operation access */

function pi_inquiry_manager_participants_group_join_access($inquiry_nid, $group_nid = FALSE) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry') {
		$group_check = pi_inquiry_groupings_check_group($inquiry, $group_nid);
		if ($group_check && $group_check['normal_management']) {
			$allowed_participants = $group_nid ? nquire_group_get_member_uids($inquiry->actor_gid) : pi_inquiry_groupings_get_allowed_participants_for_inquiry($inquiry);

			if (!$allowed_participants || in_array($user->uid, $allowed_participants)) {
				if ($group_check['group']->og_selective == OG_OPEN || $group_check['group']->og_selective == OG_MODERATED) {
					return TRUE;
				}
			}
		}
	}

	return FALSE;
}

function pi_inquiry_manager_participants_group_acceptinvitation_access($inquiry_nid, $group_nid = FALSE) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry') {
		$group_check = pi_inquiry_groupings_check_group($inquiry, $group_nid);
		if ($group_check && $group_check['normal_management']) {
			if ($group_check['group']->og_selective == OG_INVITE_ONLY && nquire_group_get_user_status_in_group($group_check['gid'], $user->uid)) {
				return TRUE;
			}
		}
	}

	return FALSE;
}

function pi_inquiry_manager_participants_group_leave_access($inquiry_nid, $group_nid = FALSE) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry') {
		$group_check = pi_inquiry_groupings_check_group($inquiry, $group_nid);
		if ($group_check && $group_check['normal_management']) {
			return nquire_group_get_user_status_in_group($group_check['gid'], $user->uid) !== 'none';
		}
	}

	return FALSE;
}

function pi_inquiry_manager_participants_group_manageuser_access($inquiry_nid, $group_nid = FALSE) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry') {
		$group_check = pi_inquiry_groupings_check_group($inquiry, $group_nid);
		if ($group_check) {
			return $user->uid === $group_check['manager'];
		}
	}
	return FALSE;
}

function pi_inquiry_manager_participants_subgroups_edit_policy_access($inquiry_nid) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry' && $inquiry->uid === $user->uid) {
		return pi_inquiry_groupings_has_collaboration_phases($inquiry_nid, 'group');
	}
	return FALSE;
}

function pi_inquiry_manager_participants_subgroups_view_access($inquiry_nid, $subgroup_nid) {
	if (pi_inquiry_groupings_check_group(node_load($inquiry_nid), $subgroup_nid)) {
		return TRUE;
	}

	return FALSE;
}

function pi_inquiry_manager_participants_subgroups_create_access($inquiry_nid) {
	global $user;

	$inquiry = node_load($inquiry_nid);
	if ($inquiry->type === 'pi_inquiry') {
		return $user->uid === $inquiry->uid || ($inquiry->group_creation === 'normal' && nquire_group_get_user_status_in_group($inquiry->actor_gid, $user->uid) === 'member');
	}
	return FALSE;
}

function pi_inquiry_manager_participants_subgroups_edit_access($inquiry_nid, $group_nid) {
	global $user;

	$inquiry_node = node_load($inquiry_nid);
	$group_check = pi_inquiry_groupings_check_group($inquiry_node, $group_nid);
	return $group_check && $group_check['type'] === 'group' && $group_check['manager'] === $user->uid;
}
