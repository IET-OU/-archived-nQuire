<?php
// $Id: ag.module,v 1.2 2009/06/24 09:17:48 ou_pm Exp $


/**
 * Implementation of hook_init().
 */
function ag_init() {

  jquery_ui_add(array('ui.tabs'));
  drupal_add_css(drupal_get_path('module', 'ag') .'/ag.css');
  
  // drupal_add_js(drupal_get_path('module', 'ag') .'/jquery-1.3.2.js');
  // drupal_add_js(drupal_get_path('module', 'ag') .'/jquery-ui-1.7.2.custom.min.js');
  // jquery_ui_add(array('ui.core', 'ui.draggable', 'ui.droppable', 'ui.resizable', 'ui.selectable', 'ui.sortable', 'ui.accordion', 'ui.dialog', 'ui.slider', 'ui.tabs', 'ui.datepicker', 'ui.progressbar', 'effects.core', 'effects.blind', 'effects.bounce', 'effects.clip', 'effects.drop', 'effects.explode', 'effects.fold', 'effects.highlight', 'effects.pulsate', 'effects.scale', 'effects.shake', 'effects.slide', 'effects.transfer'));
  drupal_add_js(drupal_get_path('module', 'ag') .'/ag.js');
  
}

/**
 * @file
 * Implements block for Activity Guide navigation.
 */
 
 /**  and n.uid = %d' $uid,
 * Implementation of hook_block().
 */


function build_link($first, $second, $third, $inquiry_id = 0, $stage_id = 0, $phase_id = 0, $activity_id = 0) {
	if (! $activity_id) {
		return t($first . "/" . $second . "/" . $third . "/" . $inquiry_id . "/" . $stage_id . "/" . $phase_id);
	}
	else {
		return t($first . "/" . $second . "/" . $third . "/" . $inquiry_id . "/" . $stage_id . "/" . $phase_id . "/" . $activity_id);
	}
}

function build_home_link($inquiry_id, $stage_id, $phase_id, $activity_id) {
	if (!$inquiry_id) {
		$query = "SELECT inquiry_id FROM pi_current_stage ORDER BY inquiry_id DESC";
		$result = db_fetch_object(db_query($query));
		$inquiry_id = $result->inquiry_id;
	}
	return t("home///" . $inquiry_id . "///");
	//return t("home///" . $inquiry_id . "/" . $stage_id . "/" . $phase_id . "/" . $activity_id);
}

function build_activity_link_old($inquiry_id, $stage_id, $phase_id, $activity_id, $uid) {
	
	$image_path = "images/";
	$status_image = array();
	$status_image["start"] = "creatable.png";
	$status_image["edit"] = "editable.png";
	$status_image["view"] = "viewable.png";
	$status_image["unavailable"] = "unavailable.png";
	
	$loaded_activity = load_activity($activity_id);
	$params = $loaded_activity->parameters;
					
	//get node_function and visible_status for inuiqry, activity, uid, gid
	$visible_status = get_visible_status_of_activity ($inquiry_id, $activity_id, $uid);
	$node_function = get_node_function_of_activity ($inquiry_id, $activity_id, $uid);
	
	switch ($loaded_activity->destination) {
    case "self":
		$destination = "";
        break;
    case "phase":
		$destination = t("destination=" . build_link("phase", $phase_id, "view", $inquiry_id, $stage_id, $phase_id,$activity_id));
        break;
    default:
		$destination = t("destination=" . build_home_link($inquiry_id, $stage_id, $phase_id, $activity_id));
        break;
	}
	
	$teacher_gid = check_teacher_activity_for_inquiry_activity_user ($inquiry_id, $activity_id, $uid);
	
	if ($visible_status == "unavailable") {
		$output = t("<img class='ag-icon' src=\"" . $image_path. $status_image[$visible_status] . "\"/>" . " " . "<span style='vertical-align: 10%;'>" . $loaded_activity->name . teacher_only_flag($teacher_gid) . "</span>");
	}
	elseif ($node_function == "add") {
		$link = build_link("node", $node_function, str_replace("_", "-", $loaded_activity->node_type), $inquiry_id, $stage_id, $phase_id, $activity_id);
		if ($params) {
			$link = $link . "/" . $params;
		}	
		$output = l(t("<img class='ag-icon' src=\"" . $image_path. $status_image[$visible_status] . "\"/>" . " " . "<span style='vertical-align: 10%;'>" . $loaded_activity->name . teacher_only_flag($teacher_gid) . "</span>"), $link,  array('html' => true, 'query' => $destination));
	}
	else {
		$nid = get_nid_for_inquiry_activity_and_user($inquiry_id, $activity_id, $uid);
		//$nid = get_nid_for_inquiry_activity_and_user(1, 3, 1);
		$link = build_link("node", $nid, $node_function, $inquiry_id, $stage_id, $phase_id, $activity_id);
		if ($params) {
			$link = $link . "/" . $params;
		}
		$output = l(t("<img class='ag-icon' src=\"" . $image_path. $status_image[$visible_status] . "\"/>" . " " . "<span style='vertical-align: 10%;'>" . $loaded_activity->name . teacher_only_flag($teacher_gid) . "</span>"), $link,  array('html' => true, 'query' => $destination));
	}
	
	return $output;
}

function build_activity_link($inquiry_id, $stage_id, $phase_id, $activity_id, $uid) {
	
	$image_path = "images/";
	$status_image = array();
	$status_image["start"] = "creatable.png";
	$status_image["edit"] = "editable.png";
	$status_image["view"] = "viewable.png";
	$status_image["unavailable"] = "unavailable.png";
	
	$loaded_activity = load_activity($activity_id);
	$params = $loaded_activity->parameters;
					
	//get node_function and visible_status for inuiqry, activity, uid, gid
	$visible_status = get_visible_status_of_activity ($inquiry_id, $activity_id, $uid);
	$node_function = get_node_function_of_activity ($inquiry_id, $activity_id, $uid);
	
	switch ($loaded_activity->destination) {
    case "self":
		$destination = "";
        break;
    case "phase":
		$destination = t("destination=" . build_link("phase", $phase_id, "view", $inquiry_id, $stage_id, $phase_id,$activity_id));
        break;
    default:
		$destination = t("destination=" . build_home_link($inquiry_id, $stage_id, $phase_id, $activity_id));
        break;
	}
	
	$teacher_gid = check_teacher_activity_for_inquiry_activity_user ($inquiry_id, $activity_id, $uid);
	
  $activity_name_text = $loaded_activity->name . teacher_only_flag($teacher_gid);
    
	if ($visible_status == "unavailable") {
		$output = array('data' =>  t($activity_name_text), 'class' => 'ag-activity-unavailable');
	}
	elseif ($node_function == "add") {
		$link = build_link("node", $node_function, str_replace("_", "-", $loaded_activity->node_type), $inquiry_id, $stage_id, $phase_id, $activity_id);
		if ($params) {
			$link = $link . "/" . $params;
		}	
    $activity_name_link = l($activity_name_text, $link,  array('html' => true, 'query' => $destination));
		$output = array('data' =>  t($activity_name_link), 'class' => 'ag-activity-add');
	}
	else {
		$nid = get_nid_for_inquiry_activity_and_user($inquiry_id, $activity_id, $uid);
		//$nid = get_nid_for_inquiry_activity_and_user(1, 3, 1);
		$link = build_link("node", $nid, $node_function, $inquiry_id, $stage_id, $phase_id, $activity_id);
		if ($params) {
			$link = $link . "/" . $params;
		}
    $activity_name_link = l($activity_name_text, $link,  array('html' => true, 'query' => $destination));
		$output = array('data' => t($activity_name_link), 'class' => 'ag-activity-view');
	};
	
	return $output;
}

function ag_block($op = 'list', $delta = 0, $edit = array()) {
	
	switch ($op) {
  
    case 'list':
		$blocks[0]['info'] = t('New Activity Guide');
		return $blocks;
    
    case 'view':

		global $user;
		$image_path = "images/";
		$node_details = get_inquiry_details_from_current_path();

		$phases = get_phases_of_inquiry_and_user($node_details->inquiry_id, $user->uid);

		$current_stage = get_current_stage_of_inquiry_and_user($node_details->inquiry_id, $user->uid);	
    if (isset($current_stage->stage_id)) {		
		  $current_stage_id = $current_stage->stage_id;
		}
    else {
      $current_stage_id = '';
    };
    $current_stage_phases = get_phases_of_stage ($node_details->inquiry_id, $current_stage_id);
		
		$phases_of_current_stage = array();

		while ($phase_of_current_stage = db_fetch_object($current_stage_phases)) {
			$phases_of_current_stage[] =  $phase_of_current_stage->phase_id;
		};
		
		$phase_menu_items = array();
		$phase_menu_item = array();
		
		while ($phase = db_fetch_object($phases)) {

			$loaded_phase = load_phase($phase->phase_id);
			$teacher_gid = check_teacher_phase_for_inquiry_phase_user ($node_details->inquiry_id, $phase->phase_id, $user->uid);

			$phase_link = l($loaded_phase->name . teacher_only_flag($teacher_gid), build_link("phase", $phase->phase_id, "view", $node_details->inquiry_id, $node_details->stage_id, $phase->phase_id, $node_details->activity_id), array('html' => true));
			
			$activity_menu_items = array();

			//expand activities of the phase if it is current
			if ($phase->phase_id == $node_details->phase_id) {

				//$activities = get_activities_of_stage_phase_and_user(1, NULL, NULL, 1);
				$activities = get_activities_of_stage_phase_and_user($node_details->inquiry_id, NULL, $phase->phase_id, $user->uid);

				foreach($activities as $activity) {
					$activity_menu_items[] = build_activity_link($node_details->inquiry_id, $node_details->stage_id, $phase->phase_id, $activity->activity_id, $user->uid);
				};

			};
			
			if (in_array($phase->phase_id, $phases_of_current_stage)) {
			 $phase_menu_items[] = array('data' => $phase_link, 'children' => $activity_menu_items, 'class' => 'ag-phase-current');
      }
      else {
			 $phase_menu_items[] = array('data' => $phase_link, 'children' => $activity_menu_items, 'class' => 'ag-phase');
      };
			
		};
		
		$home_link = build_home_link($node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $node_details->activity_id);

		// $block['subject'] = l(t("Sustainability investigator&nbsp;" . "<img src=\"" . $image_path . "home.png\"/>"), t($home_link), array(html=>true));
		
		$previous_answers = array("title" => "my title", "author" => "my author");

		$block_content = t(theme('item_list', $phase_menu_items, NULL, 'ul', array('class' => 'ag-phases')));

    $ag_content = "<div class='display: block; clear: both; min-height: 180px;'>" . get_ag_content() . "</div>";
      
      $loaded_current_stage = load_stage($current_stage_id);
  		$loaded_current_inquiry = load_inquiry($node_details->inquiry_id);
      if (isset($loaded_current_inquiry->name)) {
        $loaded_current_inquiry_name = $loaded_current_inquiry->name;
      }
      else {
        $loaded_current_inquiry_name = "";
      };
      if (isset($loaded_current_stage->name)) {
        $loaded_current_stage_name = $loaded_current_stage->name;
      }
      else {
        $loaded_current_stage_name = "";
      };
  		$inquiry_stage_info = "<strong>" . $loaded_current_inquiry_name . "</strong><br/>&nbsp;&nbsp;" . $loaded_current_stage_name;

		$block['content'] = "<div class='activity-guide'>" . $ag_content . $inquiry_stage_info . $block_content . "</div>";
	
		return $block;
	};
}

function teacher_only_flag ($gid) {
	if ($gid) {
		return " (T)";
	}
	else {
		return "";
	}
}

function get_ag_content() {

  $node_details = get_inquiry_details_from_current_path();
  $home_link = build_home_link($node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $node_details->activity_id);

  $content = "
  
    <div id='ag_guide'>
        
      <div id='ag_home'>
        <div id='ag_home_icon'>";
  $content .= l(t("<img src=\"images/unit-navigator-home.png\"/>"), t($home_link), array('html'=>true, 'attributes' => array('class' => 'ag-link')));
  $content .= "
        </div>
        <div id='ag_home_text'>";     
  $content .= l(t("Sustainability<br/>Investigator"), t($home_link), array('html'=>true, 'attributes' => array('class' => 'ag-link')));
  $content .= "
        </div>
      </div>";
      
  $content .= "
      <div id='ag_pullout'>
      
        <div id='ag_controls'>
          <div class='ag_rotator'>
            <div class='ag_top'>
              <a class='ag-link' href='#' id='ag_prev'><img src='images/inquiry-navigator-up.png' /></a>
            </div>
            <div class='ag_bottom'>
              <a class='ag-link' href='#' id='ag_next'><img src='images/inquiry-navigator-down.png' /></a>
            </div>
          </div>
        </div>";
  
  // get list of inquiries for current user
	global $user;
  $inquiries = get_inquiries_of_user($user->uid);
  
  $inquiry_count = 1;
  $current_inquiry_count = 1;
  
	while ($inquiry = db_fetch_object($inquiries)) {
    if ($inquiry->inquiry_id == $node_details->inquiry_id) {
      $current_inquiry_count = $inquiry_count;
    };
    $inquiry_count = $inquiry_count + 1;
  };
  
  $content .= "<div id='ag_currentinquiry'>" . $current_inquiry_count . "</div>";
        
  $content .= "
        <div id='ag_container'>
          <div id='ag_inquiries'>";
    
  $inquiries = get_inquiries_of_user($user->uid);
  
  // loop for each inquiry - identify current stage and get all stages
  // make each tab entry with stage name
	while ($inquiry = db_fetch_object($inquiries)) {

    $current_stage = get_current_stage_of_inquiry_and_user($inquiry->inquiry_id, $user->uid);
    $inquiry_link = build_home_link($inquiry->inquiry_id, $current_stage->stage_id, '', '');
    
    $content .= "<div class='ag_inquiry' stage='" . $current_stage->stage_id . "'>";
    $content .= l(t($inquiry->name), t($inquiry_link), array('attributes'=>array('class' => 'ag-link')));
    $content .= "<div class='box'>
                  <div class='tabs'>
                    <ul>";

    $stages = get_stages_of_inquiry_and_user ($inquiry->inquiry_id, $user->uid);
    $stage_count = 1;
    
    $tab_content = '';
    $tab_text_content = '';
    
    while ($stage = db_fetch_object($stages)) {
      if ($current_stage->stage_id == $stage->stage_id) {
        $tab_content .= "<li class='ag_currentstage'>";
        $tab_text_content .= "<div class='ag_currentstage' id='stagetabs-" . $inquiry->inquiry_id . "-" . $stage->stage_id . "'>";
      }
      else {
        $tab_content .= "<li class='ag_stage'>";
        $tab_text_content .= "<div class='ag_stage' id='stagetabs-" . $inquiry->inquiry_id . "-" . $stage->stage_id . "'>";
      };

      $tab_content .= "<a href='#stagetabs-" . $inquiry->inquiry_id . "-" . $stage->stage_id . "'>$stage_count</a>";
      $tab_content .= "</li>";
      
      $stage_data = load_stage($stage->stage_id);
      $tab_text_content .= $stage_data->name;
      $tab_text_content .= "</div>";
      
      $stage_count = $stage_count + 1;
    };
    
    $content .= $tab_content;
    $content .= "</ul>";
    
    $content .= $tab_text_content;
  
    $content .= "
                  </div>
                </div>
              </div>";
             
  }; 
  
  $content .= "
          </div>
        </div>
      
      </div>
      
      <div id='ag_pullouthandle'>
        <div class='ag_middle_arrow'>
          <a class='ag-link' href='#' id='inquiry-toggle'><img id='ag_handle' src='images/unit-navigator-open.png' /></a>
        </div>
      </div>
      
    </div>

  ";
  
  return $content;
  
}

