<?php
// $Id: pi_sort_data.module,v 1.2 2010/02/15 09:17:48 ou_pm Exp $

function pi_sort_data_node_info() {
	return array(
	    'pi_sort_data' => array(
		    'name' => t('Data sort data'), // Required.
		    'module' => 'pi_sort_data',  // Required.
		    'description' => t('Data sort'), // Required.
		    'has_title' => TRUE,
		    'title_label' => t(''),
		    'has_body' => TRUE,
		    'body_label' => t('Sort of collected data'),
		    'locked' => TRUE,
		    'add_node_type' => 'pi_data'
		)
	);

}

function pi_sort_data_perm() {
}

function pi_sort_data_access($op, $node) {
	global $user;
	$details = get_inquiry_details_from_current_path();

	if ($op == 'create') {
		return check_node_function_of_activity ($details->inquiry_id, $details->activity_id, $user->uid, 'add');
	}

	if ($op == 'update') {
		return check_node_function_of_activity ($details->inquiry_id, $details->activity_id, $user->uid, 'edit');
	}
}


/**
 * Implementation of hook_theme().
 */
function pi_sort_data_theme() {
	return array(
	    'pi_sort_data_node_form' => array(
	    	'arguments' => array('form'),
		),
	    'pi_sort_data' => array(
	   		'arguments' => array('node', 'teaser', 'data_items_to_show'),
		),
	);
}


/**
 * hook_form() for pi_sort_data which provides draggable sorting for pi_data nodes in an inquiry
 * @param $node the pi_sort_data node if it is to be edited, as per drupal 6 API
 */
function pi_sort_data_form(&$node) {
	global $user;
	$node_details = get_inquiry_details_from_current_path();
	if (is_numeric($node_details->activity_id))
	{
		$current_activity = load_activity($node_details->activity_id);
	}
	 
	if ($current_activity->name)
	{
		$users_group = get_group_of_type($user->uid, $current_activity->audience,
		$node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $node_details->activity_id);
		if($users_group!=false)
		{
			$group = node_load($users_group);
			$sort_for = $group->title;
		}
		else
		{
			$sort_for = $user->name;
		}
		$node_title = check_plain(t('Data for ') . $sort_for);
		drupal_set_title($node_title);
	}
	else
	{
		$type = node_get_types('type', $node);
		$node_title = $type->name;
	}
	 
	// Build the form
	$form = array();

	$form['title'] = array (
        '#type' => 'hidden',
        '#value' => $node_title,
	);

	// onepageprofile_categories and tree used for draggable menu items
	$form['onepageprofile_categories'] = array(
        '#tree'   => TRUE,
	);

	// Add the categories of existing nodes and the options list for new nodes
	if(isset($node->nid)) {
		$node_categories = $node->categories;
	}
	else {
		$node_categories = array();
	}

	$option_categories = pi_sort_data_get_options();
	
	$categories = pi_merge_content_item_lists($node_categories, $option_categories);
	
	// set $tree to point to the above $form['onepageprofile_categories'] object
	$tree = &$form['onepageprofile_categories'];
	foreach ($categories as $key => $category)
	{
		$measure = node_load($key);
		$new_title = $category['#title'];
		if (strlen($category['#title']) > 3)
		{
			if (substr($category['#title'], 0, 3) == 'D: ')
			{
				$new_title = substr($category['#title'], 3);
			}
		}
		// add $tree entries for current category (i.e. $key)
		$tree[$key]['title'] = array(
            '#value' => t($new_title),
		);

		$tree[$key]['weight'] = array(
            '#type'          => 'weight',
            '#delta'         => max(10, count($categories)),
            '#default_value' => $node_categories[$key]['#weight'],
		);
	}
	return $form;
}

function pi_sort_data_insert($node) {
	foreach($node->onepageprofile_categories as $key => $measure)
	{
		db_query("INSERT INTO pi_sort_data (nid, vid, data, weight) VALUES (%d, %d, '%s', %d)",
			$node->nid, $node->vid, $key, $measure['weight']);
		pi_activity_update_activity_weight_from_node($key, $measure['weight']);
	}
}

function pi_sort_data_update($node) {
	// if this is a new node or we're adding a new revision,
	if ($node->revision)
	{
		pi_sort_data_insert($node);
	}
	else
	{
		db_query("DELETE FROM pi_sort_data WHERE vid = %d", $node->vid);
		pi_sort_data_insert($node);
	}
}

function pi_sort_data_delete(&$node) {
	db_query("DELETE FROM pi_sort_data WHERE nid = %d", $node->nid);
}


function pi_sort_data_load($node) {
	$result = new stdClass;
	$result->categories = pi_sort_data_get_choice($node);
	return $result;
}


function pi_sort_data_view($node, $teaser, $page = FALSE) {
	global $user;
	$node_details = get_inquiry_details_from_current_path();
	
	$node = node_prepare($node, $teaser);
	
	if (is_numeric($node_details->activity_id))
	{
		$current_activity = load_activity($node_details->activity_id);
		if ($current_activity->name)
		{
			drupal_set_title(check_plain($current_activity->name));
		}
	}
	
	// Assemble an array of key questions in the output format (build_activity_link makes this a link with icon)
	$already_sorted_data_items = $node->categories;
	$unsorted_data_items = pi_sort_data_get_options();
    $sorted_data_items = pi_merge_content_item_lists($already_sorted_data_items, $unsorted_data_items);
	$data_items_to_show = array();
	foreach(array_keys($sorted_data_items) as $sorted_data_items_nid)
	{
		$data_item_activity_id = get_activity_id_for_nid($sorted_data_items_nid);
		if ($data_item_activity_id)
		{
			$data_item_node = node_load($sorted_data_items_nid);
			$data_item_activity = pi_activity_load($data_item_activity_id);
			$activity_link = build_activity_link($node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $data_item_activity_id, $user->uid);
			$activity_teaser = pi_activity_teaser($data_item_node, $data_item_activity, 'view');
			$data_items_to_show[] = array(
				'title' => $activity_link['data'],
				'description' => $activity_teaser			
			);
		}
	}
	
	if($teaser && count($data_items_to_show)>0)
	{
		//Link to add a new key question
		//cannot get activity id from $node_details when viewing a list of activity teasers
		$activity_id_for_this_node = get_activity_id_for_nid($node->nid);
		$link_output = make_add_activity_link($node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $activity_id_for_this_node, $user->uid);
		$node->content['pi_sort_key_questions_add_key_question_link'] =  array(
            '#value' =>$link_output,
            '#weight' => -3
		);
	}	
	
	
	
	
	$node->content['pi_sort_data'] = array(
            '#value' => theme('pi_sort_data', $node, $teaser, $data_items_to_show),
            '#weight' => 2
	);

	return $node;
}

function theme_pi_sort_data($node, $teaser, $data_items_to_show) {
	global $user;
	 
	$output = '';

	$header = array(
		t("Data")
	);

	$rows = array();
	if (is_array($data_items_to_show))
	{
		foreach($data_items_to_show as $data_item)
		{
			$title_for_row = $data_item['title'];
			$description_for_row =  str_replace(
				array('<div', '</div', 'class="submitted"'), 
				array('<span', '</span', 'class="submitted" style="display:none"'),  
				$data_item['description']);
			
			$rows[] =	'<div style="padding-left:40px; text-indent: -40px;margin-bottom:6px;"><span style="font-size:115%;font-weight:bold;padding-right:10px;">' . $title_for_row . '</span>' .
							'<span>' . $description_for_row . '</span>' .
						'</div>';
		}
	}

	if(count($rows) > 0)
	{
		$output .= '<h3>You have collected this data:</h3>';
		$output .= theme('item_list', $rows, NULL, 'ul', array('style' => 'list-style-type:none'));

		//$output .= theme('table', $header, $rows);
	}
	else {
		$output .= 'No data entries are available';
	}
	return $output;
}



/**
 * Theme for sort data form
 */
function theme_pi_sort_data_node_form($form) {
	global $user;
	$uid = $user->uid;
	$details = get_inquiry_details_from_current_path();
	if (is_numeric($details->activity_id)) {
		$current_activity = load_activity($details->activity_id);
	}
	 
	if ($current_activity->name) {
		drupal_set_title(t($current_activity->name));
	}

	drupal_add_tabledrag('onepageprofile-categories', 'order', 'sibling', 'onepageprofile-element');

	// Header
	$header = array(
	t('Data'),
	t('Weight')
	);

	// Rows for the tabledrag
	$rows = array();

	$tree = &$form['onepageprofile_categories'];
	foreach (element_children($tree) as $key) {
		$tree[$key]['weight']['#attributes']['class'] = 'onepageprofile-element';

		$row = array();
		$row[] = drupal_render($tree[$key]['title']);
		$row[] = drupal_render($tree[$key]['weight']);

		$rows[] = array('data' => $row, 'class' => 'draggable');
	}

	// Build the output
	if ($current_activity->description) {
		$output  .= '<p>' . t($current_activity->description) . '</p>';
	}
	else {
		$output  .= '<p>' . t('Order your data.') . '</p>';
	}

	if (count($rows) > 0) {
		$output .= theme('table', $header, $rows, array('id' => 'onepageprofile-categories'));
		$output .= drupal_render($form);
	}
	else {
		$output .= "<p>No data is available.</p>";
	}
	return $output;
}

/**
 * Load the user edit form and grab all of the fieldsets
 */
function pi_sort_data_get_choice($node) {

	global $user;
	$categories = array();

	$result = db_query("SELECT * FROM pi_sort_data WHERE pi_sort_data.nid = '" . $node->nid . "' AND pi_sort_data.vid = '" . $node->vid . "'");

	while ($row = db_fetch_object($result)) {
		$activity_id = get_activity_id_for_nid($row->data);
		$activity = load_activity($activity_id);
		$categories[$row->data] = array(
            '#weight' => $row->weight,
            '#title'  => t($activity->name)
		);
	}

	uasort($categories, "my_weight_compare");

	return $categories;
}


/**
 * Load the user edit form and grab all of the fieldsets
 */
function pi_sort_data_get_options() {
	global $user;
	$details = get_inquiry_details_from_current_path();
	$categories = array();

	$result = db_query("SELECT DISTINCT node.nid FROM node LEFT JOIN node_access ON node.nid = node_access.nid LEFT JOIN og_uid ON node_access.gid = og_uid.nid LEFT JOIN pi_activity_node ON pi_activity_node.nid =  node.nid WHERE TYPE = 'pi_data' AND STATUS = '1' AND (node_access.realm =  'all' OR og_uid.uid =  '" . $user->uid . "') AND pi_activity_node.inquiry_id = '" . $details->inquiry_id . "' ORDER BY nid ASC");

	while ($row = db_fetch_object($result)) {
		$activity_id = get_activity_id_for_nid($row->nid);
		$activity = load_activity($activity_id);
		$categories[$row->nid] = array(
				'#weight' => 1,
				'#title'  => t($activity->name)
		);
	}
	return $categories;
}
