<?php

// $Id: pi_sort_data.module,v 1.2 2010/02/15 09:17:48 ou_pm Exp $

function pi_sort_data_node_info() {
	return array(
			'pi_sort_data' => array(
					'name' => t('Inquiry show and sort data'), // Required.
					'module' => 'pi_sort_data', // Required.
					'description' => t('Data sort'), // Required.
					'has_title' => FALSE,
					'title_label' => t('Sorted data'),
					'has_body' => TRUE,
					'body_label' => t('Sort of collected data'),
					'locked' => TRUE,
					'add_node_type' => 'pi_data'
			)
	);
}

function pi_sort_data_perm() {
	
}

function pi_sort_data_access($op, $node, $account) {
	return FALSE;
}

/**
 * Implementation of hook_theme().
 */
function pi_sort_data_theme() {
	return array(
			'pi_sort_data' => array(
					'arguments' => array('node', 'teaser', 'data_items_to_show'),
			),
	);
}

/**
 * hook_form() for pi_sort_data which provides draggable sorting for pi_data nodes in an inquiry
 * @param $node the pi_sort_data node if it is to be edited, as per drupal 6 API
 */
function pi_sort_data_form(&$node) {

	$form = array();

	return $form;
}

function pi_sort_data_custom_edit_page($node) {
	global $user;

	$data_nids = pi_sort_data_get_data_for_sort_node_nid($node->nid);
	$activity_id_for_this_node = pi_activity_get_activity_nid_for_content_nid($node->nid);
	$selected_measures = pi_methodology_get_measures_for_use_in_content_node($node->nid, $activity_id_for_this_node);

	$header = array();
	$header[] = t('Created:');
	$measures = array();
	foreach ($selected_measures as $measure_nid => $required) {
		$measure = node_load($measure_nid);
		if (pi_data_tools_measure_plugin_show_in_table($measure)) {
			$header[] = check_plain($measure->title) . t(':');
			$measures[] = $measure;
		}
	}


	$data_rows = array();

	foreach ($data_nids as $nid) {
		$row = array();
		$data_item_node = node_load($nid);
		$data_item_activity_nid = pi_activity_get_activity_nid_for_content_nid($nid);

		$row[] = format_date($data_item_node->created, 'custom', 'Y/m/d H:i') . '<br/>'
						. t('by !user', array('!user' => nquire_commons_user_name_or_me($data_item_node->uid, $user->uid))) . '<br/>'
						. l(t('edit'), 'activity/' . $data_item_activity_nid . '/edit') . '&nbsp;&nbsp;&nbsp;'
						. l(t('delete'), 'activity/' . $data_item_activity_nid . '/delete');

		foreach ($measures as $measure) {
			$row[] = pi_data_tools_measure_plugin_format_table_value($measure, $data_item_node->values[$measure->nid]);
		}
		$data_rows[] = $row;
	}


	return theme('pi_sort_data', $header, $data_rows);
}

function pi_sort_data_view($node, $teaser, $page = FALSE) {
	global $user;

	$node = node_prepare($node, $teaser);

	$data_nids = pi_sort_data_get_data_for_sort_node_nid($node->nid);
	$activity_id_for_this_node = pi_activity_get_activity_nid_for_content_nid($node->nid);
	$selected_measures = pi_methodology_get_measures_for_use_in_content_node($node->nid, $activity_id_for_this_node);

	$header = array();
	$header[] = t('Created:');
	$measures = array();
	foreach ($selected_measures as $measure_nid => $required) {
		$measure = node_load($measure_nid);
		if (pi_data_tools_measure_plugin_show_in_table($measure)) {
			$header[] = check_plain($measure->title) . t(':');
			$measures[] = $measure;
		}
	}


	$data_rows = array();

	foreach ($data_nids as $nid) {
		$row = array();
		$data_item_node = node_load($nid);
		$data_item_activity_nid = pi_activity_get_activity_nid_for_content_nid($nid);

		$row[] = format_date($data_item_node->created, 'custom', 'Y/m/d H:i') . '<br/>'
						. t('by !user', array('!user' => nquire_commons_user_name_or_me($data_item_node->uid, $user->uid)));

		foreach ($measures as $measure) {
			$row[] = pi_data_tools_measure_plugin_format_table_value($measure, $data_item_node->values[$measure->nid]);
		}
		$data_rows[] = $row;
	}


	$node->content['pi_sort_data'] = array(
			'#value' => theme('pi_sort_data', $header, $data_rows),
			'#weight' => 2
	);

	return $node;
}

function pi_sort_data_create_contribution_view($node) {
	return pi_sort_data_create_shared_view($node);
}

function pi_sort_data_create_shared_view($node) {
	global $user;

	$data_nids = pi_sort_data_get_data_for_sort_node_nid($node->nid);
	$activity_id_for_this_node = pi_activity_get_activity_nid_for_content_nid($node->nid);

	$selected_measures = pi_methodology_get_measures_for_use_in_content_node($node->nid, $activity_id_for_this_node);


	if (!$selected_measures) {
		$selected_measures = array();
	}

	$header = array();
	$header[] = t('Created:');
	$measures = array();
	foreach ($selected_measures as $measure_nid => $required) {
		$measure = node_load($measure_nid);
		if (pi_data_tools_measure_plugin_show_in_table($measure)) {
			$header[] = check_plain($measure->title) . t(':');
			$measures[] = $measure;
		}
	}


	$data_rows = array();

	foreach ($data_nids as $nid) {
		$row = array();
		$data_item_node = node_load($nid);

		$row[] = format_date($data_item_node->created, 'custom', 'Y/m/d H:i') . '<br/>'
						. t('by !user', array('!user' => nquire_commons_user_name_or_me($data_item_node->uid, $user->uid)));

		foreach ($measures as $measure) {
			$row[] = pi_data_tools_measure_plugin_format_table_value($measure, $data_item_node->values[$measure->nid]);
		}
		$data_rows[] = $row;
	}

	return theme('pi_sort_data', $header, $data_rows);
}

function theme_pi_sort_data($header, $data_rows) {
	drupal_add_js(drupal_get_path('module', 'pi_sort_data') . '/js/sorttable.js');
	drupal_add_css(drupal_get_path('module', 'pi_sort_data') . '/css/sorttable.css');

	return theme('table', $header, $data_rows, array(
			'class' => 'sortable'
	));
}

function pi_sort_data_get_activities($inquiry_nid) {
	$inquiry_info = pi_info()->getInquiryInfo($inquiry_nid);
	return $inquiry_info->getActivityNidsByType('pi_sort_data');
}

function pi_sort_data_get_data_for_sort_node_nid($sort_data_nid) {
	return pi_activity_get_children_content_nids_for_content_nid($sort_data_nid);
}

function pi_sort_data_get_all_data_for_use_in_content_nid($using_content_nid, $sort_data_activity_nid) {
	$content_access = pi_info()->getContentManager();

	$sort_data_nids = $content_access->getContentFromForUsingContent($sort_data_activity_nid, $using_content_nid);
	return $content_access->getChildrenContentForContentNids($sort_data_nids);
}

function pi_sort_data_delete_activity($activity_node) {
	$measures_for_activity = pi_available_measures_get_script_measure_nids_for_sort_data_activity_nid($activity_node->nid);
	foreach ($measures_for_activity as $measure_nid) {
		node_delete($measure_nid);
	}
}
