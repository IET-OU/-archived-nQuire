<?php
// $Id: ag.module,v 1.2 2009/06/24 09:17:48 ou_pm Exp $


/**
 * Implementation of hook_init().
 */
function pi_ag_navigation_init() {
}

/**
 * @file
 * Implements block for Activity Guide navigation.
 */
 
 /**  and n.uid = %d' $uid,
 * Implementation of hook_block().
 */
function pi_ag_navigation_block($op = 'list', $delta = 0, $edit = array()) {
	
	switch ($op) {
  
    case 'list':
		$blocks[0]['info'] = t('PI Activity Guide Navigation Menu');
		return $blocks;
    
    case 'view':
		global $user;
		$image_path = "images/";
		$node_details = get_inquiry_details_from_current_path();
		
		//get default inquiry_id if not set
		if($node_details->inquiry_id)
		{
			$inquiries = get_inquiries_of_user($user->uid);
			while ($inquiry_from_db=db_fetch_object($inquiries)) 
			{
				if ($inquiry_from_db->inquiry_id == $node_details->inquiry_id)
				{
					$inquiry = $inquiry_from_db;
				}
  			}
		}
		else
		{
			$db_result = get_inquiries_of_user ($user->uid);
			$inquiry = db_fetch_object($db_result);
		}
		
		$current_stage = get_current_stage_of_inquiry_and_user($inquiry->inquiry_id, $user->uid);	
		if (isset($current_stage->stage_id))
		{		
			$current_stage_id = $current_stage->stage_id;
		}
		else
		{
			$current_stage_id = '';
		};
		
		$current_stage_phases = get_phases_of_stage($inquiry->inquiry_id, $current_stage_id);
		$phases_of_current_stage = array();
		while ($phase_of_current_stage = db_fetch_object($current_stage_phases))
		{
			$phases_of_current_stage[] =  $phase_of_current_stage->phase_id;
		};
		
		$phase_menu_items = array();
		$phase_menu_item = array();
		
		$current_activity_ids = array();
		$current_activities = get_activities_of_stage_phase_and_user($inquiry->inquiry_id, $current_stage->stage_id, $phase->phase_id, $user->uid);
		foreach($current_activities as $activity)
		{
			$current_activity_ids[] = $activity->activity_id;
		};
		
		$phases = get_phases_of_inquiry_and_user($inquiry->inquiry_id, $user->uid);	
		while ($phase=db_fetch_object($phases))
		{
			$loaded_phase = load_phase($phase->phase_id);
			$teacher_gid = check_teacher_phase_for_inquiry_phase_user ($inquiry->inquiry_id, $phase->phase_id, $user->uid);

			$phase_link = l($loaded_phase->name . teacher_only_flag($teacher_gid), 
				pi_ag_build_link("phase", $phase->phase_id, "view", $inquiry->inquiry_id, $inquiry->stage_id, $phase->phase_id, $inquiry->activity_id),
				array('html' => true) );

			$activity_menu_items = array();
			$activities = get_activities_of_stage_phase_and_user($inquiry->inquiry_id, NULL, $phase->phase_id, $user->uid);
			foreach($activities as $activity)
			{
				if(in_array($activity->activity_id, $current_activity_ids))
				{
					$activity_menu_items[] = pi_ag_build_activity_link($inquiry->inquiry_id, $inquiry->stage_id, $phase->phase_id, $activity->activity_id, $user->uid);
				}
				else
				{
					//$activity_menu_items[] = pi_ag_build_activity_link($inquiry->inquiry_id, $inquiry->stage_id, $phase->phase_id, $activity->activity_id, $user->uid);
				}
			};
			
			if (in_array($phase->phase_id, $phases_of_current_stage))
			{
				$line_class = 'ag-phase-current';
			}
			else
			{
				$line_class = 'ag-phase';
			}	
			$phase_menu_items[] = array('data' => "<div class='phase_link'>" . $phase_link . "</div>", 'children' => $activity_menu_items, 'class' => $line_class);
		};

		$home_link = pi_ag_build_home_link($inquiry->inquiry_id, $inquiry->stage_id);
		$previous_answers = array("title" => "my title", "author" => "my author");
		$block_content = theme('item_list', $phase_menu_items, NULL, 'ul', array('class' => 'ag-phases'));

		$loaded_current_stage = load_stage($current_stage_id);
		$loaded_current_inquiry = load_inquiry($inquiry->inquiry_id);

		$block['content'] = "<div class='pi_ag_navigation'>$block_content</div>";
	
		return $block;
	};
}
