<?php

// $Id: ag.module,v 1.2 2009/06/24 09:17:48 ou_pm Exp $


function ag_block($op = 'list', $delta = 0, $edit = array()) {

	switch ($op) {
		case 'list':

			$blocks = array(
					array('info' => t('Activity Guide'))
			);

			return $blocks;

		case 'view':
			global $user;
			$block = array();

			if ($user != null) {
				$access_data = pi_inquiry_groupings_get_access_data();
				if (arg(0) == 'phase' || arg(0) == 'activity') {
					$phase_menu_items = array();

					foreach ($access_data->get_phases() as $phase_nid => $phase_data) {
						$is_current_phase = $phase_nid == $access_data->get_current_phase_nid();

						if (!$phase_data['access']) {
							$phase_link = check_plain($phase_data['node']->title);
						} else {
							$phase_link = l($phase_data['node']->title, "phase/" . $phase_nid, array('html' => true));
						}

						$activity_menu_items = array();

						//expand activities of the phase if it is current
						if ($is_current_phase) {
							foreach ($phase_data['activities'] as $activity_nid => $activity_data) {
								$activity_menu_items[] = pi_activity_build_link($activity_nid, $user->uid);
							}
						}

						if ($is_current_phase) {
							$phase_class = 'expanded active-trail';
						} else {
							$phase_class = 'collapsed';
						}

						$phase_menu_items[] = array('data' => $phase_link, 'children' => $activity_menu_items, 'class' => $phase_class);
					}

					$block_content = t(theme('item_list', $phase_menu_items, NULL, 'ul', array('class' => 'menu')));

					$block['subject'] = l(t('Navigation'), 'inquiry/' . $access_data->get_inquiry_nid() . '/structure');
					$block['content'] = "<div class='activity-guide'>" . $block_content . "</div>";
				}
			}
			return $block;
	}
}

