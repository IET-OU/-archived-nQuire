<?php

// $Id: ag.module,v 1.2 2009/06/24 09:17:48 ou_pm Exp $


/**
 * @file
 * Implements block for Activity Guide navigation.
 */

/**  and n.uid = %d' $uid,
 * Implementation of hook_block().
 */
function add_activity_icon($visible_status) {
	$image_path = "/" . drupal_get_path('module', 'pi') . '/images/';
	$status_image = array();
	$status_image["start"] = "creatable.png";
	$status_image["edit"] = "editable.png";
	$status_image["view"] = "viewable.png";
	$status_image["unavailable"] = "unavailable.png";
	return "<img width='12' src='" . $image_path . $status_image[$visible_status] . "'/>";
}

function ag_block($op = 'list', $delta = 0, $edit = array()) {

	switch ($op) {
		case 'list':

			$blocks = array(
					array('info' => t('Activity Guide'))
			);

			return $blocks;

		case 'view':
			global $user;
			$block = array();

			if ($user != null) {
				$show_activities = TRUE; //show_activites($user->uid);
				$show_phases = TRUE; //show_phases($user->uid);
				//$node_details = get_inquiry_details_from_current_path();
				$access_data = pi_inquiry_groupings_get_access_data();

				//$hidden_created_activity_types = get_hidden_link_activities($node_details->inquiry_id);

				$image_path = drupal_get_path('module', 'pi') . '/images/';

				if (arg(0) == 'phase' || arg(0) == 'activity') {
					//$phases = pi_phase_load_nids_for_inquiry_for_user($node_details->inquiry_id, $user->uid);
					//$current_stage = get_current_stage_of_inquiry_and_user($node_details->inquiry_id, $user->uid);

					$phase_menu_items = array();

					foreach ($access_data->get_phases() as $phase_nid => $phase_data) {
						$is_current_phase = $phase_nid == $access_data->get_current_phase_nid();

						if (!$phase_data['access']) {
							$phase_link = check_plain($phase_data['node']->title);
						} else {
							$phase_link = l($phase_data['node']->title, "phase/" . $phase_nid, array('html' => true));
						}

						$activity_menu_items = array();

						//expand activities of the phase if it is current
						if ($is_current_phase && $show_activities) {
							foreach ($phase_data['activities'] as $activity_nid => $activity_data) {
								$activity_menu_items[] = pi_activity_build_link($activity_nid, $user->uid);
							}
						}

						if ($is_current_phase) {
							$phase_class = 'expanded active-trail';
						} else {
							$phase_class = 'collapsed';
						}

						$phase_menu_items[] = array('data' => $phase_link, 'children' => $activity_menu_items, 'class' => $phase_class);
					}

					//$home_link = ag_build_home_link($node_details->inquiry_id, $node_details->stage_id, $node_details->phase_id, $node_details->activity_id);
					$block_content = t(theme('item_list', $phase_menu_items, NULL, 'ul', array('class' => 'menu')));
					
					$block['subject'] = t('Navigation');
					$block['content'] = "<div class='activity-guide'>" . $block_content . "</div>";
				}
			}
			return $block;
	}
}

/** Generate teacher only suffix given the flag
 * @param bool $teacher_only
 * @todo theme this instead
 */
function _pi_ag_teacher_only_flag($teacher_only) {
	return $teacher_only ? " (T)" : "";
}

function new_activity_list($inquiry_id, $phase_id, $uid) {

	/*
	  $activity_list = array();
	  $new_activities = new_activities($inquiry_id, $phase_id, $uid);

	  while ($activity = db_fetch_object($new_activities)) {
	  $activity_list[] = $activity->activity_id;
	  }
	 */
	return $activity_list;
}

function new_activity_list_count($inquiry_id, $phase_id, $uid) {
	return count(new_activity_list($inquiry_id, $phase_id, $uid));
}

function do_the_phase_queries() {
	$output = "";
	$my_array = array(30 => 809, 31 => 810, 32 => 811, 33 => 812, 34 => 813, 36 => 814, 37 => 815, 38 => 816, 39 => 817, 40 => 818, 41 => 819, 42 => 820, 43 => 821, 44 => 822, 45 => 823, 46 => 824, 47 => 825, 48 => 826, 49 => 827, 50 => 828, 51 => 829, 52 => 830, 53 => 831, 54 => 832, 55 => 833, 56 => 834, 57 => 835, 58 => 836, 59 => 837, 60 => 838, 61 => 839, 62 => 840, 63 => 854, 64 => 855, 65 => 856, 66 => 857, 67 => 858, 68 => 859, 69 => 860, 70 => 861);
	foreach ($my_array as $key => $value) {
		$output .= "UPDATE pi_inquiry_grouping SET pi_inquiry_grouping.phase_id='" . $value . "' WHERE pi_inquiry_grouping.phase_id='" . $key . "'; UPDATE pi_inquiry_phase SET pi_inquiry_phase.phase_id='" . $value . "' WHERE pi_inquiry_phase.phase_id='" . $key . "'; UPDATE pi_phase_actor SET pi_phase_actor.phase_id='" . $value . "' WHERE pi_phase_actor.phase_id='" . $key . "'; UPDATE pi_stage_phase SET pi_stage_phase.phase_id='" . $value . "' WHERE pi_stage_phase.phase_id='" . $key . "';";
	}
	return $output;
}

