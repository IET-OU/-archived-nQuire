<?php

// $Id: ag.module,v 1.2 2009/06/24 09:17:48 ou_pm Exp $


function ag_block($op = 'list', $delta = 0, $edit = array()) {

	switch ($op) {
		case 'list':

			$blocks = array(
					array('info' => t('Activity Guide'))
			);

			return $blocks;

		case 'view':
			global $user;
			$block = array();

			if ($user != null) {
				$current_path = pi_info()->getCurrentPath();
				$inquiry_info = pi_info()->getCurrentInquiryInfo();
				if ($inquiry_info && (arg(0) == 'phase' || arg(0) == 'activity')) {
					$inquiry_access = pi_info()->getAccessManager($inquiry_info->getInquiryNid(), $user->uid);

					$phase_menu_items = array();

					foreach ($inquiry_info->getPhases() as $phase_nid => $phase_node) {
						$is_current_phase = $phase_nid == $current_path->phase_nid;

						if ($inquiry_access->getAccessToItem($phase_node) === 'hidden') {
							$phase_link = check_plain($phase_node->title);
						} else {
							$phase_link = l($phase_node->title, "phase/" . $phase_nid, array('html' => true));
						}

						$activity_menu_items = array();

						//expand activities of the phase if it is current
						if ($is_current_phase) {
							foreach ($inquiry_info->getActivitiesForPhase($phase_nid) as $activity_node) {
								$activity_menu_items[] = pi_activity_build_link($activity_node->nid, $user->uid);
							}
						}

						if ($is_current_phase) {
							$phase_class = 'expanded active-trail';
						} else {
							$phase_class = 'collapsed';
						}

						$phase_menu_items[] = array('data' => $phase_link, 'children' => $activity_menu_items, 'class' => $phase_class);
					}

					$block_content = t(theme('item_list', $phase_menu_items, NULL, 'ul', array('class' => 'menu')));

					$block['subject'] = l(t('Navigation'), 'inquiry/' . $inquiry_info->getInquiryNid() . '/structure');
					$block['content'] = "<div class='activity-guide'>" . $block_content . "</div>";
				}
			}
			return $block;
	}
}

